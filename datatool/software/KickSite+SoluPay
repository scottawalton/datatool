### This file documents the process of merging the KickSite Export with the SoluPay export


df = procedures.load(args.filename, args.filepath)
fin = procedures.load('financial.csv', args.filepath)

procedures.fix_ranks(df)
procedures.strip_whitespace(fin)

fin['LastUpdate'] = pd.to_datetime(fin['LastUpdate'])
fin['FirstName'] = fin['FirstName'].str.upper()
fin['LastName'] = fin['LastName'].str.upper()

fin = fin.sort_values('LastUpdate', ascending=False).groupby(['FirstName', 'LastName'], as_index=False).head(1)

adults = pd.DataFrame(columns=fin.columns.values)
parents = pd.DataFrame(columns=fin.columns.values)

for index, row in fin.iterrows():
    if row['FirstName'] in df['First Name'].str.upper().tolist():
        if row['LastName'] in df['Last Name'].str.upper().tolist():
            adults = adults.append(row)
        elif row['LastName'] in df['Middle Name'].str.upper().tolist():
            adults = adults.append(row)
    else:
        for i in df['Guardians'].str.upper().tolist():
            if not(isinstance(i, float)):
                if row['FirstName'] in i and row['LastName'] in i:
                    parents = parents.append(row)

                elif df['Last Name'].str.upper().tolist().count(row['LastName']) == 1:
                    parents = parents.append(row)

                else:
                    ## This slows everything down to snail speed, but its fine for now
                    for x in df['Guardian 2'].str.upper().tolist():
                        if not(isinstance(x, float)):
                            if row['FirstName'] in x and row['LastName'] in x:
                                parents = parents.append(row)


fin = fin.loc[~fin['CustNum'].isin(adults['CustNum'])]

fin = fin.loc[~fin['CustNum'].isin(parents['CustNum'])]

print('\a')
